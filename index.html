
<!DOCTYPE html>
<html>
  <head>
    <title>项楠的博客</title>
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/github-markdown-css/2.8.0/github-markdown.css" rel="stylesheet">
    <!-- <link href="https://cdn.bootcss.com/highlight.js/7.3/styles/default.css" rel="stylesheet"> -->
    <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
    <style type="text/css">
      .title {
        font-size: 300%;
        background-color: #eee;
        padding: .5em .2em;
        margin-bottom: 1em;
      }
      .container {
        width: 980px;
        margin: 10px auto;
      }
      .load {
          position: absolute;   
          top: 50%;   
          left: 50%;   
          font-size: 500%;
          z-index: 100;
      }
    </style>
  </head>
  <body>
  <div id="app" class="container">
    <!-- <div v-if="loading" class="load">加载中...</div> -->
    <div v-if="error" class="alert alert-danger" role="alert">{{error}}</div>
    <span v-if="loading" class="glyphicon glyphicon-refresh load"></span>
    <router-view></router-view>
  </div>
<script src="https://cdn.bootcss.com/vue/2.3.4/vue.min.js"></script>
<script src="https://cdn.bootcss.com/vue-router/2.6.0/vue-router.min.js"></script>
<script src="https://cdn.bootcss.com/vue-resource/1.3.4/vue-resource.min.js"></script>
<script src="https://cdn.bootcss.com/marked/0.3.6/marked.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<!-- <script src="https://cdn.lzwlkj.cn/highlight.pack.js"></script> -->

<script type="text/javascript">
var bus = new Vue()
marked.setOptions({
  highlight: function (code) {
    return hljs.highlightAuto(code).value;
  }
});
var [username, github, com] = window.location.host.split('.')
username = username || 'xiangnanscu'
var PREFIX = `https://api.github.com/repos/${username}/${username}.github.com/contents`
var COMMIT_URL = `https://api.github.com/repos/${username}/${username}.github.com/git/commits/`

var CACHE = {}

var d = `
<div>

<ol class="breadcrumb">
  <li v-for="e in navList" :class="{active:e.active}">
    <router-link v-if="e.active" :to="e.path">{{e.name}}</router-link>
    <template v-else>{{e.name}}</template>
  </li>
</ol> 

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">
      文章 ({{files.length}})
    </h3>
  </div>
  <div class="panel-body">
    <ul v-for="file in files" class="nav nav-pills nav-stacked">
      <li role="presentation">
        <router-link :to="'/file/'+file.path" role="button">{{file.name.slice(0,-3)}}</router-link>
      </li>
    </ul>
  </div>
</div>
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">
      类别 ({{folders.length}})
    </h3>
  </div>
  <div class="panel-body">
    <ul v-for="folder in folders" class="nav nav-pills nav-stacked">
      <li role="presentation">
        <router-link :to="'/folder/'+folder.path">{{folder.name}}</router-link>
      </li>
    </ul>
  </div>
</div>
</div>
`
var f = `
<div>
  <ol class="breadcrumb">
    <li v-for="e in navList" :class="{active:e.active}">
      <router-link v-if="e.active" :to="e.path">{{e.name}}</router-link>
      <template v-else>{{e.name}}</template>
    </li>
  </ol> 
  <h1 class="title">{{title}}</h1>
  <div class="markdown-body" v-html="content"></div>
  <hr>
  <p> 
    <a class="btn btn-default" :href="html_url">github</a>  
    <a class="btn btn-default" :href="download_url">raw</a>
    <a class="btn btn-default" :href="edit_url">edit</a> 
  </p>
</div>
`
var ACTIVE_ROOT = [{active: true, name: 'home', path: '/'}]
var ROOT = [{active: false, name: 'home', path: '/'}]

var folderView = {
    template: d,
    props: {
        path: {type: String, default: ''},
    },
    data () {
      return {
        tree: [],
      }
    },
    methods: {
      fetchData () {
        var url = PREFIX + this.path
        console.log('folder:',url)
        if (CACHE[url]) {
          console.log('read from cache')
          this.tree = CACHE[url]   
        } else {
          bus.$emit('set-loading')
          Vue.http.get(url, {timeout:2000}).then(
            response => {
              bus.$emit('set-loading')
              // console.log(response)
              CACHE[url] = response.body
              this.tree = response.body
            },
            response => {
              bus.$emit('set-loading')
              bus.$emit('set-error', response.bodyText||'加载数据失败')
              // console.log('Fail to get tree', response)
            }
          )
        }        
      },
    },
    watch: {
      '$route': 'fetchData',
    },
    updated () {
      console.log('folder updated')
    },
    mounted: function () {
      this.fetchData()
    },
    computed: {
      files () {
        return this.tree.filter(e => e.type == 'file' && e.name.slice(-3) == '.md')
      },
      folders () {
        return this.tree.filter(e => e.type == 'dir')
      },   
      navList () {
        var path = this.$route.params.path
        if (path=='') {
          return ROOT
        } else {
          var p = '/folder'
          var ret = path.slice(1).split('/').map(
            name => {
              p = p + '/' + name
              return {active: true, name: name, path: p}
            }
          )
          ret[ret.length-1].active = false
          return ACTIVE_ROOT.concat(ret)
        }
      },
    },
}

var fileView = {
    template: f,
    props: {
      path: {type: String, default: ''}
    },
    data: function () {
      return {
        content: '',
        title: '',
        download_url: '',
        html_url: '',
        commit_time: '',
      }
    },
    methods: {
      fetchData () {
        var url = PREFIX + this.path
        if (CACHE[url]) {
          console.log('read from cache')
          this.content = CACHE[url].content
          this.title = CACHE[url].title    
          this.download_url = CACHE[url].download_url   
          this.html_url = CACHE[url].html_url       
          // this.commit_time = CACHE[url].commit_time
        } else {
          bus.$emit('set-loading')
          Vue.http.get(url, {timeout:2000}).then(
            response => {
              bus.$emit('set-loading')
              var b = response.body
              this.content = marked(decodeURIComponent(escape(atob(b.content))))
              this.title = b.name.slice(0, -3)
              this.download_url = b.download_url
              this.html_url = b.html_url
              CACHE[url] = {content: this.content, title: this.title, 
                download_url: this.download_url, html_url: this.html_url,
              }
              // Vue.http.get(COMMIT_URL+b.sha).then(
              //   response => {
              //     this.commit_time = '2010' //response.obdy
              //   },
              //   response => {},
              // )
            },
            response => {
              bus.$emit('set-loading')
              bus.$emit('set-error', response.bodyText||'加载数据失败, 请刷新页面尝试')
            }
          )
        }        
      },
    },
    watch: {
      '$route': 'fetchData',
    },
    updated () {
      console.log('file updated')
    },
    mounted: function () {
      this.fetchData()
    },
    computed: {
      edit_url () {
        return this.html_url.replace('/blob/', '/edit/')
      },
      navList () {
        var p = '/folder'
        var ret = this.$route.params.path.slice(1).split('/').slice(0, -1)
          .filter(name=>name!="").map(
            name => {
              p = p + '/' + name
              return {active: true, name: name, path: p}
            }
        )
        return ACTIVE_ROOT.concat(ret)
      },
    },
  }

var router = new VueRouter({
  linkActiveClass: "router-link-active",
  linkExactActiveClass: "router-link-exact-active",
  routes: [
    {
      path: '/', 
      redirect: '/folder',
    },
    {
      path: '/folder:path(.*)', 
      component: folderView,
      props: function (route) {
        console.log('folder route.params.path', route.params.path)
        return {path: route.params.path}
      },
    },
    {
      path: '/file:path(.+)', 
      component: fileView,
      props: function (route) {
        console.log('file route.params.path', route.params.path)
        return {path: route.params.path}
      },
    },
  ],
})

app = new Vue({
  el: '#app',
  data: {
    loading: false,
    error: null,
  },
  created () {
    bus.$on('set-loading', () => {this.loading = !this.loading})
    bus.$on('set-error', (message) => {
      this.error = message
      setTimeout(() => {this.error = null}, 3000)
    })
  },
  router: router,
})


</script>
</body>
</html>